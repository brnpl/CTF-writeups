## Overview
This writeup details the reverse engineering of an Android application that requires modifying the return value of a native function. The goal is to hook the `check_flag()` JNI method using Frida to change its return value from `1` to `1337`, which unlocks an encrypted flag.

## Initial analysis
First, the `AndroidManifest.xml` is examined to understand the app structure. Analysis reveals a single `MainActivity`.

```xml
<?xml version="1.0" encoding="utf-8"?>
<manifest xmlns:android="http://schemas.android.com/apk/res/android" android:versionCode="1" android:versionName="1.0" android:compileSdkVersion="34" android:compileSdkVersionCodename="14" package="com.ad2001.a0x9" platformBuildVersionCode="34" platformBuildVersionName="14">
    <uses-sdk android:minSdkVersion="28" android:targetSdkVersion="34"/>
    <permission android:name="com.ad2001.a0x9.DYNAMIC_RECEIVER_NOT_EXPORTED_PERMISSION" android:protectionLevel="signature"/>
    <uses-permission android:name="com.ad2001.a0x9.DYNAMIC_RECEIVER_NOT_EXPORTED_PERMISSION"/>
    <application android:theme="@style/Theme.Frida0x9" android:label="@string/app_name" android:icon="@mipmap/ic_launcher" android:debuggable="true" android:allowBackup="true" android:supportsRtl="true" android:extractNativeLibs="false" android:fullBackupContent="@xml/backup_rules" android:roundIcon="@mipmap/ic_launcher_round" android:appComponentFactory="androidx.core.app.CoreComponentFactory" android:dataExtractionRules="@xml/data_extraction_rules">
        <activity android:name="com.ad2001.a0x9.MainActivity" android:exported="true">
            <intent-filter>
                <action android:name="android.intent.action.MAIN"/>
                <category android:name="android.intent.category.LAUNCHER"/>
            </intent-filter>
        </activity>
        <provider android:name="androidx.startup.InitializationProvider" android:exported="false" android:authorities="com.ad2001.a0x9.androidx-startup">
            <meta-data android:name="androidx.emoji2.text.EmojiCompatInitializer" android:value="androidx.startup"/>
            <meta-data android:name="androidx.lifecycle.ProcessLifecycleInitializer" android:value="androidx.startup"/>
            <meta-data android:name="androidx.profileinstaller.ProfileInstallerInitializer" android:value="androidx.startup"/>
        </provider>
        <receiver android:name="androidx.profileinstaller.ProfileInstallReceiver" android:permission="android.permission.DUMP" android:enabled="true" android:exported="true" android:directBootAware="false">
            <intent-filter>
                <action android:name="androidx.profileinstaller.action.INSTALL_PROFILE"/>
            </intent-filter>
            <intent-filter>
                <action android:name="androidx.profileinstaller.action.SKIP_FILE"/>
            </intent-filter>
            <intent-filter>
                <action android:name="androidx.profileinstaller.action.SAVE_PROFILE"/>
            </intent-filter>
            <intent-filter>
                <action android:name="androidx.profileinstaller.action.BENCHMARK_OPERATION"/>
            </intent-filter>
        </receiver>
    </application>
</manifest>
```

## Java analysis
Next, the APK is decompiled with `jadx-gui` to examine `MainActivity.java`. The `MainActivity` loads a native library called `a0x9` and declares a JNI method `check_flag()`. The native library is loaded using `System.loadLibrary("a0x9")` in the static initializer.

```java
package com.ad2001.a0x9;

import android.os.Bundle;
import android.view.View;
import android.widget.Button;
import android.widget.Toast;
import androidx.appcompat.app.AppCompatActivity;
import com.ad2001.a0x9.databinding.ActivityMainBinding;
import java.security.InvalidKeyException;
import java.security.NoSuchAlgorithmException;
import java.util.Base64;
import javax.crypto.BadPaddingException;
import javax.crypto.Cipher;
import javax.crypto.IllegalBlockSizeException;
import javax.crypto.NoSuchPaddingException;
import javax.crypto.spec.SecretKeySpec;

/* loaded from: classes3.dex */
public class MainActivity extends AppCompatActivity {
    private ActivityMainBinding binding;
    Button btn;

    public native int check_flag();

    static {
        System.loadLibrary("a0x9");
    }

    /* JADX INFO: Access modifiers changed from: protected */
    @Override // androidx.fragment.app.FragmentActivity, androidx.activity.ComponentActivity, androidx.core.app.ComponentActivity, android.app.Activity
    public void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        ActivityMainBinding inflate = ActivityMainBinding.inflate(getLayoutInflater());
        this.binding = inflate;
        setContentView(inflate.getRoot());
        Button button = (Button) findViewById(C0568R.C0571id.button);
        this.btn = button;
        button.setOnClickListener(new View.OnClickListener() { // from class: com.ad2001.a0x9.MainActivity.1
            @Override // android.view.View.OnClickListener
            public void onClick(View v) {
                if (MainActivity.this.check_flag() == 1337) {
                    try {
                        Cipher cipher = Cipher.getInstance("AES");
                        SecretKeySpec secretKeySpec = new SecretKeySpec("3000300030003003".getBytes(), "AES");
                        try {
                            cipher.init(2, secretKeySpec);
                            byte[] decryptedBytes = Base64.getDecoder().decode("hBCKKAqgxVhJMVTQS8JADelBUPUPyDiyO9dLSS3zho0=");
                            try {
                                String decrypted = new String(cipher.doFinal(decryptedBytes));
                                Toast.makeText(MainActivity.this.getApplicationContext(), "You won " + decrypted, 1).show();
                                return;
                            } catch (BadPaddingException e) {
                                throw new RuntimeException(e);
                            } catch (IllegalBlockSizeException e2) {
                                throw new RuntimeException(e2);
                            }
                        } catch (InvalidKeyException e3) {
                            throw new RuntimeException(e3);
                        }
                    } catch (NoSuchAlgorithmException e4) {
                        throw new RuntimeException(e4);
                    } catch (NoSuchPaddingException e5) {
                        throw new RuntimeException(e5);
                    }
                }
                Toast.makeText(MainActivity.this.getApplicationContext(), "Try again", 1).show();
            }
        });
    }
}
```

## Native library analysis
`Ghidra` is used to disassemble and decompile the `liba0x9.so` library. The JNI function `Java_com_ad2001_a0x9_MainActivity_check_1flag` is trivially simple and always return the integer 1.

```c
undefined4 Java_com_ad2001_a0x9_MainActivity_check_1flag(void)

{
  return 1;
}
```

This exploit script demonstrates how to intercept and modify the return value of the native function. The `setTimeout()` ensures the app is fully initialized before hooking. 

`Module.findExportByName()` locates the mangled JNI function `Java_com_ad2001_a0x9_MainActivity_check_1flag` in the `liba0x9.so` library.

The `onLeave` callback receives a `retval` object representing the return value pointer. The original return value (1) is logged, then `retval.replace(1337)` overwrites it with the magic value 1337 that satisfies the Java conditional check.

```js
setTimeout(function () {

    var addr = Module.findExportByName("liba0x9.so",
        "Java_com_ad2001_a0x9_MainActivity_check_1flag");

    console.log("[*] address of check_1flag():", addr);

    Interceptor.attach(addr, {
        onLeave(retval) {
            try {
                console.log("[*] raw retval pointer:", retval);

                // override return value
                retval.replace(1337);

                console.log("[*] new return value to 1337");

            } catch (e) {
                console.log("[!] could not modify return value:", e);
            }
        }
    });

}, 1000);
```

The output confirms that the function was located at `0xba9635a0` and that the hook successfully intercepted `check_1flag()`, changing its return value from `1` to `1337`.

```shell
$ frida -U -f com.ad2001.a0x9 -l script.js
     ____
    / _  |   Frida 16.7.13 - A world-class dynamic instrumentation toolkit
   | (_| |
    > _  |   Commands:
   /_/ |_|       help      -> Displays the help system
   . . . .       object?   -> Display information about 'object'
   . . . .       exit/quit -> Exit
   . . . .
   . . . .   More info at https://frida.re/docs/home/
   . . . .
   . . . .   Connected to Nexus 4 (id=)
Spawned `com.ad2001.a0x9`. Resuming main thread!                        
[Nexus 4::com.ad2001.a0x9 ]-> [*] address of check_1flag(): 0xba9635a0
[*] Raw retval pointer: 0x1
[*] Modified return value to 1337
```

## Flag
FRIDA{NATIVE_LAND_0X2}