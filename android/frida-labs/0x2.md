# Overview
This writeup details the reverse engineering of an Android application that requires direct method invocation using Frida. The goal is to reverse engineer the hidden flag retrieval mechanism and directly call the `get_flag()` method with the correct parameter to decrypt and display the flag.

## Initial analysis
The `AndroidManifest.xml` shows a simple application structure similar to the previous challenge. The main activity `com.ad2001.frida0x2.MainActivity` is the entry point.

```xml
<?xml version="1.0" encoding="utf-8"?>
<manifest xmlns:android="http://schemas.android.com/apk/res/android" android:versionCode="1" android:versionName="1.0" android:compileSdkVersion="33" android:compileSdkVersionCodename="13" package="com.ad2001.frida0x2" platformBuildVersionCode="33" platformBuildVersionName="13">
    <uses-sdk android:minSdkVersion="28" android:targetSdkVersion="33"/>
    <permission android:name="com.ad2001.frida0x2.DYNAMIC_RECEIVER_NOT_EXPORTED_PERMISSION" android:protectionLevel="signature"/>
    <uses-permission android:name="com.ad2001.frida0x2.DYNAMIC_RECEIVER_NOT_EXPORTED_PERMISSION"/>
    <application android:theme="@style/Theme.Frida0x2" android:label="@string/app_name" android:icon="@mipmap/ic_launcher" android:debuggable="true" android:allowBackup="true" android:supportsRtl="true" android:extractNativeLibs="false" android:fullBackupContent="@xml/backup_rules" android:roundIcon="@mipmap/ic_launcher_round" android:appComponentFactory="androidx.core.app.CoreComponentFactory" android:dataExtractionRules="@xml/data_extraction_rules">
        <activity android:name="com.ad2001.frida0x2.MainActivity" android:exported="true">
            <intent-filter>
                <action android:name="android.intent.action.MAIN"/>
                <category android:name="android.intent.category.LAUNCHER"/>
            </intent-filter>
        </activity>
        <provider android:name="androidx.startup.InitializationProvider" android:exported="false" android:authorities="com.ad2001.frida0x2.androidx-startup">
            <meta-data android:name="androidx.emoji2.text.EmojiCompatInitializer" android:value="androidx.startup"/>
            <meta-data android:name="androidx.lifecycle.ProcessLifecycleInitializer" android:value="androidx.startup"/>
        </provider>
    </application>
</manifest>
```

## Java analysis
Decompiling the APK with `jadx-gui` reveals the `MainActivity` source code. Unlike the previous challenge, this application has no user interaction and the flag is hidden in a static method `get_flag()` that is never called during normal execution. 

The method performs the following operations:
1. Checks if the input parameter equals `4919`;
2. If correct, decrypts a Base64-encoded encrypted string using AES-CBC encryption
3. Uses the key "HILLBILLWILLBINN" and a zero IV (Initialization Vector);
4. Displays the decrypted flag in a TextView;

The challenge here is that `get_flag()` is never called in the normal application flow. We need to use Frida to directly invoke this method with the correct parameter (`4919`) to decrypt and reveal the flag.

```java
package com.ad2001.frida0x2;

import android.os.Bundle;
import android.util.Base64;
import android.widget.TextView;
import androidx.appcompat.app.AppCompatActivity;
import javax.crypto.Cipher;
import javax.crypto.spec.IvParameterSpec;
import javax.crypto.spec.SecretKeySpec;

/* loaded from: classes3.dex */
public class MainActivity extends AppCompatActivity {

    /* renamed from: t1 */
    static TextView f103t1;

    /* JADX INFO: Access modifiers changed from: protected */
    @Override // androidx.fragment.app.FragmentActivity, androidx.activity.ComponentActivity, androidx.core.app.ComponentActivity, android.app.Activity
    public void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(C0569R.layout.activity_main);
        f103t1 = (TextView) findViewById(C0569R.C0572id.textview);
    }

    public static void get_flag(int a) {
        if (a == 4919) {
            try {
                SecretKeySpec secretKeySpec = new SecretKeySpec("HILLBILLWILLBINN".getBytes(), "AES");
                Cipher cipher = Cipher.getInstance("AES/CBC/PKCS5Padding");
                IvParameterSpec iv = new IvParameterSpec(new byte[16]);
                cipher.init(2, secretKeySpec, iv);
                byte[] decryptedBytes = cipher.doFinal(Base64.decode("q7mBQegjhpfIAr0OgfLvH0t/D0Xi0ieG0vd+8ZVW+b4=", 0));
                String decryptedText = new String(decryptedBytes);
                f103t1.setText(decryptedText);
            } catch (Exception e) {
                e.printStackTrace();
            }
        }
    }
}
```

This Frida script hooks the `onCreate()` method to capture the Activity instance, then calls `get_flag()` on that instance. 

Since `get_flag()` is a static method, we can call it directly through the instance. The script uses a timer loop to wait until the instance is ready before invoking the method.

```js
var instance = null; // global

function hookOnCreate() {
    var MainActivity = Java.use("com.ad2001.frida0x2.MainActivity");

    MainActivity.onCreate.overload('android.os.Bundle').implementation = function (b) {
        this.onCreate(b);
        instance = this;
        console.log("[*] activity instance captured");
    };
}

function callGetFlag() {
    console.log("[*] calling method get_flag()");
    instance.get_flag(4919);
}

Java.perform(function () {
    hookOnCreate();

    // wait until instance is ready (retry loop)
    var timer = setInterval(function () {
        if (instance) {
            clearInterval(timer);
            callGetFlag();
        }
    }, 100);
});
```

Running this script successfully captures the Activity instance and calls the `get_flag()` method with the magic number `4919`, which triggers the AES decryption and displays the flag on the screen.

```shell
$ frida -U -l script.js -f com.ad2001.frida0x2
     ____
    / _  |   Frida 16.7.13 - A world-class dynamic instrumentation toolkit
   | (_| |
    > _  |   Commands:
   /_/ |_|       help      -> Displays the help system
   . . . .       object?   -> Display information about 'object'
   . . . .       exit/quit -> Exit
   . . . .
   . . . .   More info at https://frida.re/docs/home/
   . . . .
   . . . .   Connected to Pixel 4a (id=)
Spawned `com.ad2001.frida0x2`. Resuming main thread!                    
[Pixel 4a::com.ad2001.frida0x2 ]-> [*] Activity instance captured
[*] calling method get_flag()
```

## Flag
FLAG{BABY_HOOKS_0X2}

## Alternative solution
Alternatively, you can use Frida's interactive REPL to directly invoke the static method. This is simpler and doesn't require a separate script file. Simply start Frida and execute the Java code directly to call `get_flag()` with the correct parameter.

```shell
$ frida -U -f com.ad2001.frida0x2  
     ____
    / _  |   Frida 16.7.13 - A world-class dynamic instrumentation toolkit
   | (_| |
    > _  |   Commands:
   /_/ |_|       help      -> Displays the help system
   . . . .       object?   -> Display information about 'object'
   . . . .       exit/quit -> Exit
   . . . .
   . . . .   More info at https://frida.re/docs/home/
   . . . .
   . . . .   Connected to Pixel 4a (id=)
Spawned `com.ad2001.frida0x2`. Resuming main thread!                    
[Pixel 4a::com.ad2001.frida0x2 ]-> Java.perform(function() {
 
    var MainActivity = Java.use("com.ad2001.frida0x2.MainActivity");
    MainActivity.get_flag(4919);
 
})
[Pixel 4a::com.ad2001.frida0x2 ]->
```