## Overview
This writeup details the reverse engineering of an Android application that requires hooking an existing instance method using Frida. The goal is to reverse engineer the flag retrieval mechanism by intercepting the `onCreate()` method to capture the Activity instance, then calling the `flag()` method on that instance to decrypt and display the hidden flag.

## Initial analysis
The `AndroidManifest.xml` shows a simple application structure with the main activity `com.ad2001.frida0x5.MainActivity` as the entry point.

```xml
<?xml version="1.0" encoding="utf-8"?>
<manifest xmlns:android="http://schemas.android.com/apk/res/android" android:versionCode="1" android:versionName="1.0" android:compileSdkVersion="33" android:compileSdkVersionCodename="13" package="com.ad2001.frida0x5" platformBuildVersionCode="33" platformBuildVersionName="13">
    <uses-sdk android:minSdkVersion="28" android:targetSdkVersion="33"/>
    <permission android:name="com.ad2001.frida0x5.DYNAMIC_RECEIVER_NOT_EXPORTED_PERMISSION" android:protectionLevel="signature"/>
    <uses-permission android:name="com.ad2001.frida0x5.DYNAMIC_RECEIVER_NOT_EXPORTED_PERMISSION"/>
    <application android:theme="@style/Theme.Frida0x5" android:label="@string/app_name" android:icon="@mipmap/ic_launcher" android:debuggable="true" android:allowBackup="true" android:supportsRtl="true" android:extractNativeLibs="false" android:fullBackupContent="@xml/backup_rules" android:roundIcon="@mipmap/ic_launcher_round" android:appComponentFactory="androidx.core.app.CoreComponentFactory" android:dataExtractionRules="@xml/data_extraction_rules">
        <activity android:name="com.ad2001.frida0x5.MainActivity" android:exported="true">
            <intent-filter>
                <action android:name="android.intent.action.MAIN"/>
                <category android:name="android.intent.category.LAUNCHER"/>
            </intent-filter>
        </activity>
        <provider android:name="androidx.startup.InitializationProvider" android:exported="false" android:authorities="com.ad2001.frida0x5.androidx-startup">
            <meta-data android:name="androidx.emoji2.text.EmojiCompatInitializer" android:value="androidx.startup"/>
            <meta-data android:name="androidx.lifecycle.ProcessLifecycleInitializer" android:value="androidx.startup"/>
        </provider>
    </application>
</manifest>
```

## Java analysis
Decompiling the APK with `jadx-gui` reveals the `MainActivity` class containing an instance method `flag()` that is never called during normal application execution. The method performs the following operations:
1. Checks if the input parameter equals `1337`;
2. If correct, decrypts a Base64-encoded encrypted string using AES-CBC encryption;
3. Uses the key "WILLIWOMNKESAWEL" and a zero IV (Initialization Vector);
4. Displays the decrypted flag in a TextView;

The challenge here is that `flag()` is an instance method that requires access to the Activity instance to be called. 

Unlike challenge 0x4 where we could create a new instance with `$new()`, calling `flag()` requires a properly initialized `MainActivity` instance because it accesses the TextView field which is only initialized during `onCreate()`. 

Therefore, we need to hook into the existing `onCreate()` lifecycle method to capture the real Activity instance and call `flag()` on it.

```java
package com.ad2001.frida0x5;

import android.os.Bundle;
import android.widget.TextView;
import androidx.appcompat.app.AppCompatActivity;
import java.util.Base64;
import javax.crypto.Cipher;
import javax.crypto.spec.IvParameterSpec;
import javax.crypto.spec.SecretKeySpec;

/* loaded from: classes3.dex */
public class MainActivity extends AppCompatActivity {

    /* renamed from: t1 */
    TextView f103t1;

    /* JADX INFO: Access modifiers changed from: protected */
    @Override // androidx.fragment.app.FragmentActivity, androidx.activity.ComponentActivity, androidx.core.app.ComponentActivity, android.app.Activity
    public void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(C0569R.layout.activity_main);
        this.f103t1 = (TextView) findViewById(C0569R.C0572id.textview);
    }

    public void flag(int code) {
        if (code == 1337) {
            try {
                SecretKeySpec secretKeySpec = new SecretKeySpec("WILLIWOMNKESAWEL".getBytes(), "AES");
                Cipher cipher = Cipher.getInstance("AES/CBC/PKCS5Padding");
                IvParameterSpec iv = new IvParameterSpec(new byte[16]);
                cipher.init(2, secretKeySpec, iv);
                byte[] decodedEnc = Base64.getDecoder().decode("2Y2YINP9PtJCS/7oq189VzFynmpG8swQDmH4IC9wKAY=");
                byte[] decryptedBytes = cipher.doFinal(decodedEnc);
                String decryptedText = new String(decryptedBytes);
                this.f103t1.setText(decryptedText);
            } catch (Exception e) {
                e.printStackTrace();
            }
        }
    }
}
```

The Frida script hooks the `onCreate()` method by replacing its implementation. The key technique here is that we first call the original `onCreate()` method using `this.onCreate(b)` to ensure the Activity is properly initialized (including the TextView). Then, since we're inside the hooked method, this refers to the actual MainActivity instance that Android created. We can directly call `this.flag(1337)` on this instance to trigger the AES decryption and display the flag.

This approach is different from challenge 0x4 where we created a fresh instance with `$new()`. Here, we're intercepting an existing instance during its lifecycle.

```js
Java.perform(function () {
    var MainActivity = Java.use("com.ad2001.frida0x5.MainActivity");

    MainActivity.onCreate.implementation = function (b) {
        this.onCreate(b);
        console.log("[*] onCreate hooked, calling flag()");
        this.flag(1337);
    };
});
```

Running the script successfully hooks the `onCreate()` method. When the Activity is created, our hook executes, first allowing the normal initialization to complete, then calling `flag(1337)` on the initialized instance. This triggers the AES decryption and displays the flag on screen.

```shell
$ frida -U -l script.js -f com.ad2001.frida0x5
     ____
    / _  |   Frida 16.7.13 - A world-class dynamic instrumentation toolkit
   | (_| |
    > _  |   Commands:
   /_/ |_|       help      -> Displays the help system
   . . . .       object?   -> Display information about 'object'
   . . . .       exit/quit -> Exit
   . . . .
   . . . .   More info at https://frida.re/docs/home/
   . . . .
   . . . .   Connected to Pixel 4a (id=)
Spawned `com.ad2001.frida0x5`. Resuming main thread!                    
[Pixel 4a::com.ad2001.frida0x5 ]-> [*] onCreate hooked, calling flag()
```

## Flag
FRIDA{ON_MATCH_THIS_INSTANCE}